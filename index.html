<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blade Messages</title>
<style>
  body, html {
    margin:0;padding:0;height:100%;background:#000;color:#fff;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    overflow:hidden;
  }
  
  /* Login Screen */
  #loginScreen, #addContactScreen {
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    height:100vh;position:relative;z-index:1;
  }
  h1 {
    font-size:3.2rem;font-weight:800;
    background:linear-gradient(135deg,#fff,#ccc);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    margin:0 0 40px;letter-spacing:-1.5px;
  }
  .chip-icon {font-size:4rem;margin-bottom:20px;opacity:0.9;}
  .instruction {
    font-size:1.25rem;line-height:1.6;opacity:0.85;max-width:500px;text-align:center;
  }
  .status {margin-top:28px;font-size:1.1rem;min-height:32px;}
  .btn {
    margin-top:40px;padding:16px 56px;font-size:1.2rem;font-weight:600;
    background:transparent;color:#fff;border:2px solid #555;border-radius:18px;
    cursor:pointer;transition:all 0.35s ease;
  }
  .btn:hover {border-color:#0f9;box-shadow:0 0 40px rgba(0,255,150,0.35);}
  .btn:active {transform:scale(0.95);}
  .scan-glow {
    position:fixed;inset:0;pointer-events:none;z-index:0;
    background:radial-gradient(circle at center, rgba(0,255,150,0.2) 0%, transparent 70%);
    opacity:0;
  }
  body.scanning .scan-glow, #addContactScreen.scanning .scan-glow {
    opacity:1;animation:greenPulse 1.8s infinite;
  }
  @keyframes greenPulse {
    0%,100% {opacity:0.4;transform:scale(1);}
    50% {opacity:0.9;transform:scale(1.18);}
  }
  
  #passwordStage, #contactPasswordStage {
    position:fixed;inset:0;background:#000;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    opacity:0;visibility:hidden;z-index:10;transition:opacity 0.8s ease;
  }
  #passwordStage.visible, #contactPasswordStage.visible {opacity:1;visibility:visible;}
  
  body.step2 h1, body.step2 .chip-icon, body.step2 .instruction,
  body.step2 .status, body.step2 .btn {opacity:0;transition:opacity 0.5s ease;}
  body.step2 .scan-glow {opacity:0 !important;transition:opacity 0.5s ease;}
  
  #addContactScreen.step2 h1, #addContactScreen.step2 .chip-icon,
  #addContactScreen.step2 .instruction, #addContactScreen.step2 .status,
  #addContactScreen.step2 .btn {opacity:0;transition:opacity 0.5s ease;}
  #addContactScreen.step2 .scan-glow {opacity:0 !important;transition:opacity 0.5s ease;}
  
  input {
    padding:20px;font-size:2rem;letter-spacing:12px;text-align:center;
    background:#111;color:#fff;border:2px solid #444;border-radius:16px;width:340px;
  }
  input:focus {outline:none;border-color:#0f9;box-shadow:0 0 30px rgba(0,255,150,0.3);}
  
  #addContactScreen {display:none;}
  
  /* Main App with Sidebar */
  #mainApp {
    display:none;height:100vh;
  }
  #mainApp.active {display:flex;}
  
  .app-container {display:flex;height:100vh;}
  
  /* Sidebar */
  .sidebar {
    width:320px;background:#0a0a0a;border-right:2px solid #222;
    display:flex;flex-direction:column;
  }
  .sidebar-header {
    background:#111;padding:20px;border-bottom:2px solid #222;
  }
  .sidebar-header h2 {margin:0 0 15px;font-size:1.6rem;}
  .sidebar-btns {display:flex;gap:8px;flex-wrap:wrap;}
  .sidebar-btn {
    padding:8px 14px;background:#222;border:1px solid #444;
    border-radius:6px;cursor:pointer;transition:all 0.2s;font-size:0.9rem;
  }
  .sidebar-btn:hover {background:#333;border-color:#0f9;}
  
  .contact-list {flex:1;overflow-y:auto;padding:10px;}
  .contact-card {
    background:#111;padding:16px;border-radius:10px;margin-bottom:10px;
    border:2px solid #222;cursor:pointer;transition:all 0.3s;
  }
  .contact-card:hover {border-color:#0f9;box-shadow:0 0 15px rgba(0,255,150,0.15);}
  .contact-card.active {border-color:#0f9;background:#151515;}
  .contact-name {font-size:1.2rem;font-weight:600;margin-bottom:5px;}
  .contact-preview {font-size:0.85rem;opacity:0.5;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .contact-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
  .unread-badge {
    background:#0f9;color:#000;padding:4px 10px;
    border-radius:12px;font-weight:700;font-size:0.8rem;
  }
  .delete-contact-btn {
    padding:6px 12px;background:#f33;border:none;
    border-radius:6px;color:#fff;cursor:pointer;font-size:0.85rem;
    margin-top:10px;
  }
  .delete-contact-btn:hover {background:#f55;}
  
  /* Main Chat Area */
  .main-content {flex:1;display:flex;flex-direction:column;}
  
  .chat-header {
    background:#111;padding:20px;border-bottom:2px solid #222;
  }
  .chat-header h3 {margin:0;font-size:1.8rem;}
  
  .messages-container {
    flex:1;overflow-y:auto;padding:20px;display:flex;
    flex-direction:column;gap:16px;background:#050505;
  }
  .message {
    max-width:70%;padding:16px;border-radius:12px;word-wrap:break-word;
  }
  .message.sent {
    align-self:flex-end;background:#0f9;color:#000;
  }
  .message.received {
    align-self:flex-start;background:#1a1a1a;color:#fff;border:1px solid #222;
  }
  .message-time {font-size:0.75rem;opacity:0.6;margin-top:6px;}
  .message-actions {margin-top:10px;display:flex;gap:8px;}
  .reply-btn, .delete-msg-btn {
    padding:6px 12px;border-radius:6px;cursor:pointer;
    font-size:0.85rem;border:1px solid #444;background:#111;
  }
  .reply-btn:hover {background:#222;border-color:#0f9;}
  .delete-msg-btn {border-color:#f33;}
  .delete-msg-btn:hover {background:#f33;color:#fff;}
  .reply-indicator {
    opacity:0.6;font-size:0.85rem;margin-bottom:8px;
    padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;
  }
  
  .compose-area {
    background:#111;padding:20px;border-top:2px solid #222;
    display:flex;gap:12px;align-items:center;
  }
  .compose-input {
    flex:1;padding:14px;background:#222;border:2px solid #333;
    border-radius:8px;color:#fff;font-size:1rem;
  }
  .compose-input:focus {outline:none;border-color:#0f9;}
  .send-btn {
    padding:14px 28px;background:#0f9;color:#000;
    border:none;border-radius:8px;font-weight:700;
    cursor:pointer;transition:all 0.2s;
  }
  .send-btn:hover {box-shadow:0 0 20px rgba(0,255,150,0.4);}
  
  /* Message Link Modal */
  .modal {
    position:fixed;inset:0;background:rgba(0,0,0,0.9);
    display:none;align-items:center;justify-content:center;z-index:100;
  }
  .modal.active {display:flex;}
  .modal-content {
    background:#111;padding:40px;border-radius:16px;
    border:2px solid #333;max-width:500px;width:90%;
  }
  .modal-title {font-size:1.8rem;margin-bottom:30px;text-align:center;}
  .link-display {
    background:#222;padding:20px;border-radius:8px;
    margin-top:20px;word-break:break-all;
  }
  .link-display textarea {
    width:100%;background:#111;color:#0f9;border:1px solid #333;
    border-radius:6px;padding:12px;font-family:monospace;
    font-size:0.9rem;resize:vertical;min-height:100px;
  }
  .copy-btn {
    margin-top:10px;padding:10px 20px;background:#0f9;
    color:#000;border:none;border-radius:6px;cursor:pointer;
    font-weight:600;width:100%;
  }
  .copy-btn:hover {box-shadow:0 0 15px rgba(0,255,150,0.3);}
  .modal-btn {
    padding:12px 32px;border-radius:8px;cursor:pointer;
    font-size:1rem;font-weight:600;transition:all 0.2s;
    width:100%;margin-top:10px;
  }
  .modal-btn.secondary {background:#222;color:#fff;border:2px solid #444;}
  .modal-btn.secondary:hover {border-color:#666;}
  
  .hidden {display:none;}
  .empty-state {
    text-align:center;padding:60px 20px;opacity:0.6;
  }
  .empty-state-icon {font-size:4rem;margin-bottom:20px;}
</style>
</head>
<body>

<div id="loginScreen">
  <h1>BLADE MESSAGES</h1>
  <div class="chip-icon">üí≥</div>
  <div class="instruction">
    Hold your Blade Card to the right of your Trackpad or on your camera
  </div>
  <div class="status" id="status"></div>
  <button class="btn" id="tapBtn">Tap Card and press button to continue</button>
  <div class="scan-glow"></div>
  
  <div id="passwordStage">
    <input type="text" id="loginPassword" maxlength="20" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
    <p style="margin-top:18px;opacity:0.6;font-size:0.95rem;">Two Step Log In: Enter the code on your card</p>
  </div>
</div>

<div id="addContactScreen">
  <h1>ADD CONTACT</h1>
  <div class="chip-icon">üí≥</div>
  <div class="instruction">
    Ask them to hold their Blade Card to scan
  </div>
  <div class="status" id="contactStatus"></div>
  <button class="btn" id="tapContactBtn">Scan to add contact</button>
  <div class="scan-glow"></div>
  
  <div id="contactPasswordStage">
    <input type="text" id="contactPassword" maxlength="20" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
    <p style="margin-top:18px;opacity:0.6;font-size:0.95rem;">Two Step Add: They enter their card code</p>
  </div>
</div>

<div id="mainApp">
  <div class="app-container">
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>Messages</h2>
        <div class="sidebar-btns">
          <button class="sidebar-btn" id="addContactBtn">+ Add Contact</button>
          <button class="sidebar-btn" id="logoutBtn">Logout</button>
        </div>
      </div>
      <div class="contact-list" id="contactList">
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <p>No contacts yet</p>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <div id="chatView" class="hidden" style="display:flex;flex-direction:column;height:100%;">
        <div class="chat-header">
          <h3 id="chatContactName">Select a contact</h3>
        </div>
        <div class="messages-container" id="messagesContainer"></div>
        <div class="compose-area">
          <input type="text" class="compose-input" id="composeInput" placeholder="Type a message...">
          <button class="send-btn" id="sendBtn">Send</button>
        </div>
      </div>
      
      <div id="welcomeView" style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;">
        <div class="empty-state">
          <div class="empty-state-icon">‚úâÔ∏è</div>
          <h2 style="margin:20px 0;">Welcome to Blade Messages</h2>
          <p>Select a contact to start messaging</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Message Link Modal -->
<div class="modal" id="messageLinkModal">
  <div class="modal-content">
    <div class="modal-title">Message Link Generated</div>
    <p style="opacity:0.7;text-align:center;">Copy and send this link to your contact</p>
    <div class="link-display">
      <textarea id="generatedLink" readonly></textarea>
      <button class="copy-btn" id="copyLinkBtn">Copy Link</button>
    </div>
    <button class="modal-btn secondary" id="closeLinkBtn">Close</button>
  </div>
</div>

<script>
const VALID_CODES = {
  "cutedrunkraccoons": {id: "User_Alpha", name: "CuteDrunkRaccoons"},
  "blade": {id: "User_Blade", name: "Blade"},
  "card5": {id: "User_Card5", name: "Card5"},
  "golds": {id: "User_Golds", name: "Golds"},
  "tv482": {id: "User_TV482", name: "TV482"},
  "ai4me": {id: "User_AI4Me", name: "AI4Me"},
  "trash": {id: "User_Trash", name: "Trash"},
  "panda": {id: "User_Panda", name: "Panda"},
  "rocket": {id: "User_Rocket", name: "Rocket"},
  "nebul": {id: "User_Nebul", name: "Nebul"},
  "qubit": {id: "User_Qubit", name: "Qubit"},
  "zorp9": {id: "User_Zorp9", name: "Zorp9"},
  "kryp7": {id: "User_Kryp7", name: "Kryp7"},
  "fluxx": {id: "User_Fluxx", name: "Fluxx"},
  "vortex": {id: "User_Vortex", name: "Vortex"},
  "spark": {id: "User_Spark", name: "Spark"},
  "3p#q": {id: "User_3pq", name: "3p#q"}
};

let currentUser = null;
let contacts = {};
let messages = {};
let currentChatContact = null;
let autoLoadInterval = null;

// Login Flow
const status = document.getElementById('status');
const tapBtn = document.getElementById('tapBtn');
const passwordStage = document.getElementById('passwordStage');
const loginPassword = document.getElementById('loginPassword');

tapBtn.addEventListener('click', () => {
  document.body.classList.add('scanning');
  tapBtn.disabled = true;
  status.textContent = "Reading card‚Ä¶";
  status.style.color = "#ccc";

  setTimeout(() => {
    if (Math.random() < 0.70) {
      status.textContent = "Card recognized";
      status.style.color = "#0f9";
      setTimeout(() => {
        document.body.classList.add('step2');
        setTimeout(() => {
          passwordStage.classList.add('visible');
          loginPassword.focus();
        }, 500);
      }, 600);
    } else {
      document.body.classList.remove('scanning');
      status.textContent = "Not recognized ‚Äì try again";
      status.style.color = "#f66";
      tapBtn.disabled = false;
      setTimeout(() => status.textContent = "", 2200);
    }
  }, 2100);
});

loginPassword.addEventListener('input', () => {
  const code = loginPassword.value.trim().toLowerCase();
  if (VALID_CODES[code]) {
    currentUser = VALID_CODES[code].id;
    loadUserData();
    setTimeout(() => {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').classList.add('active');
      renderContacts();
      startAutoLoad();
    }, 350);
  }
});

// Auto-load messages from URL
function startAutoLoad() {
  checkForMessages();
  autoLoadInterval = setInterval(checkForMessages, 2000);
}

function checkForMessages() {
  const urlParams = new URLSearchParams(window.location.search);
  const msgParam = urlParams.get('msg');
  
  if (msgParam) {
    try {
      const decoded = decodeMessage('bladem://msg/' + msgParam);
      if (decoded && decoded.to === currentUser) {
        const senderId = decoded.from;
        
        if (contacts[senderId]) {
          if (!messages[senderId]) {
            messages[senderId] = [];
          }
          
          if (!messages[senderId].find(m => m.id === decoded.id)) {
            messages[senderId].push({
              id: decoded.id,
              from: senderId,
              msg: decoded.msg,
              time: decoded.time,
              reply: decoded.reply,
              read: false
            });
            saveUserData();
            renderContacts();
            if (currentChatContact === senderId) {
              renderMessages();
            }
          }
        }
      }
      
      // Clear the URL parameter
      window.history.replaceState({}, document.title, window.location.pathname);
    } catch (e) {
      console.error('Error loading message:', e);
    }
  }
}

// Data Management
function loadUserData() {
  const savedContacts = localStorage.getItem(`blade_contacts_${currentUser}`);
  const savedMessages = localStorage.getItem(`blade_messages_${currentUser}`);
  contacts = savedContacts ? JSON.parse(savedContacts) : {};
  messages = savedMessages ? JSON.parse(savedMessages) : {};
}

function saveUserData() {
  localStorage.setItem(`blade_contacts_${currentUser}`, JSON.stringify(contacts));
  localStorage.setItem(`blade_messages_${currentUser}`, JSON.stringify(messages));
}

// Encoding/Decoding
function encodeMessage(to, from, message, replyToId = null) {
  const msgId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  const data = {
    to: to,
    from: from,
    msg: message,
    id: msgId,
    reply: replyToId,
    time: new Date().toISOString()
  };
  const encoded = btoa(JSON.stringify(data));
  return `${window.location.origin}${window.location.pathname}?msg=${encoded}`;
}

function decodeMessage(url) {
  try {
    const encoded = url.includes('?msg=') ? url.split('?msg=')[1] : url.replace('bladem://msg/', '');
    const decoded = JSON.parse(atob(encoded));
    return decoded;
  } catch (e) {
    return null;
  }
}

// Contacts Management
function renderContacts() {
  const contactList = document.getElementById('contactList');
  contactList.innerHTML = '';
  
  const contactKeys = Object.keys(contacts);
  if (contactKeys.length === 0) {
    contactList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <p>No contacts yet</p>
      </div>
    `;
    return;
  }
  
  contactKeys.forEach(userId => {
    const contact = contacts[userId];
    const unreadCount = getUnreadCount(userId);
    const lastMsg = getLastMessage(userId);
    
    const card = document.createElement('div');
    card.className = 'contact-card' + (currentChatContact === userId ? ' active' : '');
    card.innerHTML = `
      <div class="contact-header">
        <div class="contact-name">${contact.name}</div>
        ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
      </div>
      <div class="contact-preview">${lastMsg || 'No messages yet'}</div>
      <button class="delete-contact-btn" onclick="event.stopPropagation(); deleteContact('${userId}')">Delete</button>
    `;
    
    card.addEventListener('click', () => openChat(userId));
    contactList.appendChild(card);
  });
}

function getLastMessage(userId) {
  if (!messages[userId] || messages[userId].length === 0) return '';
  const last = messages[userId][messages[userId].length - 1];
  return last.msg.substring(0, 50) + (last.msg.length > 50 ? '...' : '');
}

function getUnreadCount(userId) {
  if (!messages[userId]) return 0;
  return messages[userId].filter(m => m.from === userId && !m.read).length;
}

window.deleteContact = function(userId) {
  if (confirm(`Delete ${contacts[userId].name}?`)) {
    delete contacts[userId];
    delete messages[userId];
    if (currentChatContact === userId) {
      currentChatContact = null;
      document.getElementById('chatView').classList.add('hidden');
      document.getElementById('welcomeView').style.display = 'flex';
    }
    saveUserData();
    renderContacts();
  }
};

// Add Contact Flow
const addContactScreen = document.getElementById('addContactScreen');
const contactStatus = document.getElementById('contactStatus');
const tapContactBtn = document.getElementById('tapContactBtn');
const contactPasswordStage = document.getElementById('contactPasswordStage');
const contactPassword = document.getElementById('contactPassword');

document.getElementById('addContactBtn').addEventListener('click', () => {
  document.getElementById('mainApp').style.display = 'none';
  addContactScreen.style.display = 'flex';
  addContactScreen.classList.remove('step2');
  contactPasswordStage.classList.remove('visible');
  contactPassword.value = '';
  contactStatus.textContent = '';
  tapContactBtn.disabled = false;
});

tapContactBtn.addEventListener('click', () => {
  addContactScreen.classList.add('scanning');
  tapContactBtn.disabled = true;
  contactStatus.textContent = "Reading card‚Ä¶";
  contactStatus.style.color = "#ccc";

  setTimeout(() => {
    if (Math.random() < 0.70) {
      contactStatus.textContent = "Card recognized";
      contactStatus.style.color = "#0f9";
      setTimeout(() => {
        addContactScreen.classList.add('step2');
        setTimeout(() => {
          contactPasswordStage.classList.add('visible');
          contactPassword.focus();
        }, 500);
      }, 600);
    } else {
      addContactScreen.classList.remove('scanning');
      contactStatus.textContent = "Not recognized ‚Äì try again";
      contactStatus.style.color = "#f66";
      tapContactBtn.disabled = false;
      setTimeout(() => contactStatus.textContent = "", 2200);
    }
  }, 2100);
});

contactPassword.addEventListener('input', () => {
  const code = contactPassword.value.trim().toLowerCase();
  if (VALID_CODES[code]) {
    const userData = VALID_CODES[code];
    const userId = userData.id;
    
    if (userId === currentUser) {
      alert("You can't add yourself!");
      contactPassword.value = '';
      return;
    }
    
    contacts[userId] = {
      name: userData.name,
      code: code
    };
    
    if (!messages[userId]) {
      messages[userId] = [];
    }
    
    saveUserData();
    
    setTimeout(() => {
      addContactScreen.style.display = 'none';
      document.getElementById('mainApp').style.display = 'flex';
      renderContacts();
    }, 350);
  }
});

// Chat View
function openChat(userId) {
  currentChatContact = userId;
  document.getElementById('welcomeView').style.display = 'none';
  document.getElementById('chatView').classList.remove('hidden');
  document.getElementById('chatContactName').textContent = contacts[userId].name;
  
  if (messages[userId]) {
    messages[userId].forEach(m => {
      if (m.from === userId) m.read = true;
    });
    saveUserData();
  }
  
  renderContacts();
  renderMessages();
}

function renderMessages() {
  const container = document.getElementById('messagesContainer');
  container.innerHTML = '';
  
  if (!messages[currentChatContact] || messages[currentChatContact].length === 0) {
    container.innerHTML = '<div class="empty-state"><p>No messages yet. Start the conversation!</p></div>';
    return;
  }
  
  messages[currentChatContact].forEach((msg, idx) => {
    const div = document.createElement('div');
    div.className = `message ${msg.from === currentUser ? 'sent' : 'received'}`;
    
    let content = '';
    if (msg.reply) {
      const replyMsg = messages[currentChatContact].find(m => m.id === msg.reply);
      if (replyMsg) {
        content = `<div class="reply-indicator">Reply to: ${replyMsg.msg.substring(0, 50)}...</div>`;
      }
    }
    content += msg.msg;
    
    div.innerHTML = `
      ${content}
      <div class="message-time">${new Date(msg.time).toLocaleString()}</div>
      ${msg.from !== currentUser ? `
        <div class="message-actions">
          <button class="reply-btn" onclick="replyToMessage('${msg.id}')">Reply</button>
          <button class="delete-msg-btn" onclick="deleteMessage(${idx})">Delete</button>
        </div>
      ` : `
        <div class="message-actions">
          <button class="delete-msg-btn" onclick="deleteMessage(${idx})">Delete</button>
        </div>
      `}
    `;
    container.appendChild(div);
  });
  
  container.scrollTop = container.scrollHeight;
}

window.deleteMessage = function(idx) {
  if (confirm('Delete this message?')) {
    messages[currentChatContact].splice(idx, 1);
    saveUserData();
    renderMessages();
    renderContacts();
  }
};

let replyingTo = null;

window.replyToMessage = function(msgId) {
  replyingTo = msgId;
  document.getElementById('composeInput').placeholder = 'Replying... (Type your reply)';
  document.getElementById('composeInput').focus();
};

// Send Message
const composeInput = document.getElementById('composeInput');
const sendBtn = document.getElementById('sendBtn');
const messageLinkModal = document.getElementById('messageLinkModal');
const generatedLink = document.getElementById('generatedLink');

sendBtn.addEventListener('click', sendMessage);
composeInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendMessage();
});

function sendMessage() {
  const text = composeInput.value.trim();
  if (!text || !currentChatContact) return;
  
  const messageUrl = encodeMessage(currentChatContact, currentUser, text, replyingTo);
  
  generatedLink.value = messageUrl;
  messageLinkModal.classList.add('active');
  
  composeInput.value = '';
  composeInput.placeholder = 'Type a message...';
  replyingTo = null;
}

document.getElementById('copyLinkBtn').addEventListener('click', () => {
  generatedLink.select();
  document.execCommand('copy');
  alert('Link copied! Send it to your contact.');
});

document.getElementById('closeLinkBtn').addEventListener('click', () => {
  messageLinkModal.classList.remove('active');
});

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
  if (confirm('Logout?')) {
    if (autoLoadInterval) clearInterval(autoLoadInterval);
    currentUser = null;
    location.reload();
  }
});
</script>
</body>
</html>
